{"version":3,"file":"user.js","sources":["stores/user.js"],"sourcesContent":["import { defineStore } from 'pinia'\n\n/**\n * User Store - 用户状态管理\n * 职责：用户认证信息、个人资料、登录状态\n * 持久化：Token 存储到 SecureStorage，个人资料存储到 LocalStorage\n */\nexport const useUserStore = defineStore('user', {\n  state: () => ({\n    // 用户信息\n    userInfo: null,\n    // JWT Token\n    token: null,\n    // 登录时间戳\n    loginTime: null,\n    // 是否已认证\n    isAuthenticated: false\n  }),\n\n  getters: {\n    /**\n     * 获取用户ID\n     */\n    userId: (state) => state.userInfo?.id || null,\n\n    /**\n     * 获取用户昵称\n     */\n    nickname: (state) => state.userInfo?.nickname || '',\n\n    /**\n     * 获取用户头像\n     */\n    avatar: (state) => state.userInfo?.avatar || '',\n\n    /**\n     * 检查是否登录\n     */\n    isLoggedIn: (state) => {\n      return state.isAuthenticated && state.token !== null\n    },\n\n    /**\n     * 检查 Token 是否过期（7天）\n     */\n    isTokenExpired: (state) => {\n      if (!state.loginTime) return true\n      const expiryTime = 7 * 24 * 60 * 60 * 1000 // 7天\n      return Date.now() - state.loginTime > expiryTime\n    }\n  },\n\n  actions: {\n    /**\n     * 登录\n     * @param {Object} payload - { token, userInfo }\n     */\n    login(payload) {\n      this.token = payload.token\n      this.userInfo = payload.userInfo\n      this.loginTime = Date.now()\n      this.isAuthenticated = true\n\n      // Token 存储到 SecureStorage（如果可用）\n      try {\n        uni.setStorageSync('auth_token', payload.token)\n      } catch (error) {\n        console.error('Failed to store token:', error)\n      }\n    },\n\n    /**\n     * 登出\n     */\n    logout() {\n      this.token = null\n      this.userInfo = null\n      this.loginTime = null\n      this.isAuthenticated = false\n\n      // 清除存储的 Token\n      try {\n        uni.removeStorageSync('auth_token')\n      } catch (error) {\n        console.error('Failed to remove token:', error)\n      }\n    },\n\n    /**\n     * 更新用户资料\n     * @param {Object} userInfo - 用户信息\n     */\n    updateProfile(userInfo) {\n      this.userInfo = {\n        ...this.userInfo,\n        ...userInfo\n      }\n    },\n\n    /**\n     * 刷新 Token\n     * @param {String} newToken - 新的 Token\n     */\n    refreshToken(newToken) {\n      this.token = newToken\n      this.loginTime = Date.now()\n\n      try {\n        uni.setStorageSync('auth_token', newToken)\n      } catch (error) {\n        console.error('Failed to refresh token:', error)\n      }\n    },\n\n    /**\n     * 检查认证状态\n     * @returns {Boolean} 是否已认证且 Token 有效\n     */\n    checkAuth() {\n      if (!this.isAuthenticated || !this.token) {\n        return false\n      }\n\n      if (this.isTokenExpired) {\n        // Token 过期，自动登出\n        this.logout()\n        return false\n      }\n\n      return true\n    },\n\n    /**\n     * 从存储恢复 Token\n     */\n    restoreToken() {\n      try {\n        const token = uni.getStorageSync('auth_token')\n        if (token && this.userInfo) {\n          this.token = token\n          this.isAuthenticated = true\n        }\n      } catch (error) {\n        console.error('Failed to restore token:', error)\n      }\n    }\n  },\n\n  // 持久化配置 - 使用 UniApp 本地存储\n  // 注意：需要在 store 初始化时手动恢复状态\n  persist: false  // 暂时关闭自动持久化，使用手动方式\n})\n"],"names":["defineStore","uni"],"mappings":";;AAOY,MAAC,eAAeA,cAAW,YAAC,QAAQ;AAAA,EAC9C,OAAO,OAAO;AAAA;AAAA,IAEZ,UAAU;AAAA;AAAA,IAEV,OAAO;AAAA;AAAA,IAEP,WAAW;AAAA;AAAA,IAEX,iBAAiB;AAAA,EACrB;AAAA,EAEE,SAAS;AAAA;AAAA;AAAA;AAAA,IAIP,QAAQ,CAAC,UAAK;;AAAK,0BAAM,aAAN,mBAAgB,OAAM;AAAA;AAAA;AAAA;AAAA;AAAA,IAKzC,UAAU,CAAC,UAAK;;AAAK,0BAAM,aAAN,mBAAgB,aAAY;AAAA;AAAA;AAAA;AAAA;AAAA,IAKjD,QAAQ,CAAC,UAAK;;AAAK,0BAAM,aAAN,mBAAgB,WAAU;AAAA;AAAA;AAAA;AAAA;AAAA,IAK7C,YAAY,CAAC,UAAU;AACrB,aAAO,MAAM,mBAAmB,MAAM,UAAU;AAAA,IACjD;AAAA;AAAA;AAAA;AAAA,IAKD,gBAAgB,CAAC,UAAU;AACzB,UAAI,CAAC,MAAM;AAAW,eAAO;AAC7B,YAAM,aAAa,IAAI,KAAK,KAAK,KAAK;AACtC,aAAO,KAAK,IAAG,IAAK,MAAM,YAAY;AAAA,IACvC;AAAA,EACF;AAAA,EAED,SAAS;AAAA;AAAA;AAAA;AAAA;AAAA,IAKP,MAAM,SAAS;AACb,WAAK,QAAQ,QAAQ;AACrB,WAAK,WAAW,QAAQ;AACxB,WAAK,YAAY,KAAK,IAAK;AAC3B,WAAK,kBAAkB;AAGvB,UAAI;AACFC,sBAAAA,MAAI,eAAe,cAAc,QAAQ,KAAK;AAAA,MAC/C,SAAQ,OAAO;AACdA,sBAAAA,MAAA,MAAA,SAAA,wBAAc,0BAA0B,KAAK;AAAA,MAC9C;AAAA,IACF;AAAA;AAAA;AAAA;AAAA,IAKD,SAAS;AACP,WAAK,QAAQ;AACb,WAAK,WAAW;AAChB,WAAK,YAAY;AACjB,WAAK,kBAAkB;AAGvB,UAAI;AACFA,sBAAG,MAAC,kBAAkB,YAAY;AAAA,MACnC,SAAQ,OAAO;AACdA,sBAAAA,MAAc,MAAA,SAAA,wBAAA,2BAA2B,KAAK;AAAA,MAC/C;AAAA,IACF;AAAA;AAAA;AAAA;AAAA;AAAA,IAMD,cAAc,UAAU;AACtB,WAAK,WAAW;AAAA,QACd,GAAG,KAAK;AAAA,QACR,GAAG;AAAA,MACJ;AAAA,IACF;AAAA;AAAA;AAAA;AAAA;AAAA,IAMD,aAAa,UAAU;AACrB,WAAK,QAAQ;AACb,WAAK,YAAY,KAAK,IAAK;AAE3B,UAAI;AACFA,4BAAI,eAAe,cAAc,QAAQ;AAAA,MAC1C,SAAQ,OAAO;AACdA,sBAAAA,MAAc,MAAA,SAAA,yBAAA,4BAA4B,KAAK;AAAA,MAChD;AAAA,IACF;AAAA;AAAA;AAAA;AAAA;AAAA,IAMD,YAAY;AACV,UAAI,CAAC,KAAK,mBAAmB,CAAC,KAAK,OAAO;AACxC,eAAO;AAAA,MACR;AAED,UAAI,KAAK,gBAAgB;AAEvB,aAAK,OAAQ;AACb,eAAO;AAAA,MACR;AAED,aAAO;AAAA,IACR;AAAA;AAAA;AAAA;AAAA,IAKD,eAAe;AACb,UAAI;AACF,cAAM,QAAQA,cAAAA,MAAI,eAAe,YAAY;AAC7C,YAAI,SAAS,KAAK,UAAU;AAC1B,eAAK,QAAQ;AACb,eAAK,kBAAkB;AAAA,QACxB;AAAA,MACF,SAAQ,OAAO;AACdA,sBAAAA,MAAc,MAAA,SAAA,yBAAA,4BAA4B,KAAK;AAAA,MAChD;AAAA,IACF;AAAA,EACF;AAAA;AAAA;AAAA,EAID,SAAS;AAAA;AACX,CAAC;;"}